|||
|---------|------------------------|
|**ID**|**B0001**|
|**Objective(s)**|Anti-Behavioral Analysis|
|**Related ATT&CK Technique(s)**|None|


Sandbox Detection & Evasion
===========================
Detects whether the malware instance is being executed inside of an instrumented sandbox environment (e.g., Cuckoo Sandbox). If so, conditional execution selects a benign execution path.

Methods
-------
* **Injected DLL Testing**: Testing for the name of a particular DLL that is known to be injected by a sandbox for API hooking is a common way of detecting sandbox environments. This can be achieved through the kernel32!GetModuleHandle API call and other means.
* **Product Key/ID Testing**: Checking for a particular product key/ID associated with a sandbox environment (commonly associated with the Windows host OS used in the environment) can be used to detect whether a malware instance is being executed in a particular sandbox. This can be achieved through several means, including testing for the Key/ID in the Windows registry. 
* **Screen Resolution Testing**: Sandboxes aren't used in the same manner as a typical user environment, so most of the time the screen resolution stays at the minimum 800x600 or lower. No one is actually working on a such small screen. Malware could potentially detect the screen resolution to determine if it's a user machine or a sandbox.
* **Human User Check**: Detects whether there is any "user" activity on the machine, such as the movement of the mouse cursor, non-default wallpaper, or recently opened Office files. If there is no human activity, the machine is suspected to be a virtualized machine and/or sandbox.

Malware Examples
----------------
|||
|-----------------------------|------------------------|---------|
|[**Ursnif**](https://github.com/MAECProject/malware-behaviors/blob/master/xample-malware/ursnif.md) | May 2016 | Ursnif uses malware macros to evade sandbox detection. [[1]](#1)|
|**Terminator** | October 2013 | The Terminator rat evades a sandbox by not executing until after a reboot. Most sandboxes don't reboot during an analysis. [[2]](#2)|
|**Nap**| 2013 | Trojan Nap (tied to the Kelihos Botnet) uses extended sleep calls to evade sandbox analysis. [[2]](#2)|
|**Rebhip** | January 2011 |Rebhip detects publicly available automated analysis workbenches (e.g., Joe Box) by considering OS product keys and special DLLs. [[3]](#3)|

References
----------
<a name="1">[1]</a> https://www.cyber.nj.gov/threat-profiles/trojan-variants/ursnif 

<a name="2">[2]</a> https://www.fireeye.com/content/dam/fireeye-www/current-threats/pdfs/pf/file/fireeye-hot-knives-through-butter.pdf

<a name="3">[3]</a> https://www.fireeye.com/blog/threat-research/2011/01/the-dead-giveaways-of-vm-aware-malware.html 
 